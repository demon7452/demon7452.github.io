---
layout: post
title: Nginx学习总结
category: 技术
tags: 
keywords: Nginx
description: Nginx学习总结
---
## Nginx学习总结

### 定义
Nginx 是一款轻量级的 Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，其特点是占有内
存少，并发能力强。

### Nginx 做为 HTTP 服务器，有以下几项基本特性：
* 处理静态文件，索引文件以及自动索引；打开文件描述符缓冲．
* 无缓存的反向代理加速，简单的负载均衡和容错．
* FastCGI，简单的负载均衡和容错．
* 模块化的结构。包括 gzipping, byte ranges, chunked responses,以及 SSI-filter 等 filter。如果由 FastCGI 或其它代理服务器处理单页中存在的多个 SSI，则这项处理可以并行运行，而不需要相互等待。
* 支持 SSL 和 TLSSNI．

### Nginx 的进程模型图

![Nginx 的进程模型](http://tengine.taobao.org/book/_images/chapter-2-1.PNG)

#### 简要说明：
- 操作 Nginx:如上图所示，Nginx通过master进程来管理worker进程，所以我们只需要与master进程通信就行了。master 进程会接收来自外界发来的信号，再根据信号做不同的事情。
    - 通过 kill 向 master 进程发送信号。 
    - kill -HUP pid ，从容地重启Nginx；我们一般用这个信号来重启Nginx，或重新加载配置，重启过程中服务是不中断的。
    - master 进程在接收到 HUP 信号后是怎么做的呢？首先 master 进程在接到信号后，会先重新加
载配置文件，然后再启动新的 worker 进程，并向所有老的 worker 进程发送信号，告诉他们可以光荣退休
了。新的 worker 在启动后，就开始接收新的请求，而老的 worker 在收到来自 master 的信号后，就不再接收
新的请求，并且在当前进程中的所有未处理完的请求处理完成后，再退出。
    - Nginx 在 0.8 版本之后，引入了一系列命令行参数，来方便我们管理。比如， ./ngi
nx -s reload ，就是来重启 Nginx， ./nginx -s stop ，就是来停止 Nginx 的运行。
- worker 进程如何处理请求：
    - worker 进程之间是平等的，每个进程，处理请求的机会也是一样的。
    - 每个 worker 进程都是从 master 进程 fork 过来，在 master 进程里面，先建立好需要 listen 的 socket（listenfd）之后，然后再 fork 出多个 worker 进程。
    - 所有 worker 进程的 listenfd 会在新连接到来时变得可读，为保证只有一个进程处理该连接，所有 worker 进程在注册 listenfd 读事件前抢 accept_mutex，抢到互斥锁的那个进程注册listenfd 读事件，在读事件里调用 accept 接受该连接。
    - 当一个 worker 进程在accept这个连接之后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接。
    - 一个请求，完全由 worker 进程来处理，而且只在一个 worker 进程中处理。
- Nginx 采用这种进程模型的好处：
    - 首先，对于每个 worker进程来说，独立的进程，不需要加锁，所以省掉了锁带来的开销，同时在编程以及问题查找时，也会方便很多。
    - 其次，采用独立的进程，可以让进程互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master进程则很快启动新的 worker 进程。

### Nginx之反向代理

#### 正向代理与反向代理的介绍
- **1、正向代理的概念**
    - 正向代理，也就是传说中的代理,他的工作原理就像一个跳板，简单的说，我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。从网站的角度，只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求，也隐藏了用户的资料，这取决于代理告不告诉网站。
    - 结论就是，正向代理 是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。
- **2、反向代理的概念**
    - 举例说明:例用户访问**www,test,com/readme**，但**www,test,com**上并不存在readme页面，他是偷偷从另外一台服务器上取回来，然后作为自己的内容返回用户，但用户并不知情。这里所提到的www.test.com 这个域名对应的服务器就设置了反向代理功能。
    - 结论就是，反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。
- **3、两者区别**
    -  **在用途上的区别：**
        -  正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。正向代理还可以使用缓冲特性减少网络使用率。
        -  反向代理的典型用途是将防火墙后面的服务器提供给Internet用户访问。反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。另外，反向代理还可以启用高级URL策略和管理技术，从而使处于不同web服务器系统的web页面同时存在于同一个URL空间下。
    - **在安全性的区别**
        - 正向代理允许客户端通过它访问任意网站并且隐藏客户端自身，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。
        - 反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。
		
## 参考文档
1.<a href="http://wiki.jikexueyuan.com/project/nginx/" target="_blank">Nginx 入门指南</a><br> 
2.<a href="https://github.com/taobao/nginx-book" target="_blank">taobao/nginx-book</a><br>
3.<a href="http://tengine.taobao.org/book/index.html" target="_blank">Nginx开发从入门到精通</a><br>
4.<a href="http://freeloda.blog.51cto.com/2033581/1288553" target="_blank">Nginx 反向代理、负载均衡、页面缓存、URL重写及读写分离详解</a><br>
